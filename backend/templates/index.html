<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerebras Realtime News Analysis</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --text-color: #1c1e21;
            --secondary-text-color: #606770;
            --border-color: #dce1e6;
            --accent-color: #ff7b00;
            --accent-color-dark: #e66f00;
            --button-bg: #ffffff;
            --button-hover-bg: #f5f6f7;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-color-light: rgba(0, 0, 0, 0.05);
        }

        .dark-mode {
            --bg-color: #18191a;
            --text-color: #e4e6eb;
            --secondary-text-color: #b0b3b8;
            --border-color: #393a3b;
            --accent-color: #ff8c00;
            --accent-color-dark: #e87a00;
            --button-bg: #242526;
            --button-hover-bg: #3a3b3c;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-color-light: rgba(0, 0, 0, 0.2);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            padding: 15px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--button-bg);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s, border-color 0.3s;
            box-shadow: 0 2px 4px var(--shadow-color-light);
        }

        .header-left, .header-center, .header-right { flex: 1; display: flex; align-items: center; gap: 12px; }
        .header-left { justify-content: flex-start; }

        #topicSelect {
            font-size: 14px;
            padding: 0 12px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg);
            color: var(--text-color);
            margin-left: 16px;
            width: 240px;
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23606770%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 10px;
            cursor: pointer;
        }
        .header-center { justify-content: center; }
        .header-right { justify-content: flex-end; }

        h1 { font-size: 18px; font-weight: 600; margin: 0; }
        .container { 
            max-width: 90%;
            margin: 30px auto;
            padding: 0 20px;
            flex-grow: 1;
        }

        .control-btn {
            font-size: 14px;
            height: 40px;
            padding: 0 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--button-bg);
            color: var(--secondary-text-color);
            box-shadow: 0 1px 2px var(--shadow-color-light);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .control-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px var(--shadow-color-light);
        }

        #playPauseBtn {
            background: linear-gradient(45deg, var(--accent-color), var(--accent-color-dark));
            color: white;
            border: none;
            min-width: 120px;
            font-size: 16px;
        }

        #playPauseBtn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        #exportBtn {
            width: 40px;
            padding: 0;
            justify-content: center;
            background: var(--secondary-text-color);
            border: none;
            color: white;
        }

        #themeToggleBtn, #infoBtn {
            background-color: transparent;
            border: none;
            box-shadow: none;
            color: var(--secondary-text-color);
            font-size: 20px;
        }

        #themeToggleBtn:hover, #infoBtn:hover {
            background-color: #ccc;
            transform: translateY(0);
            box-shadow: none;
        }

        .control-btn:disabled { cursor: wait; background-color: var(--button-bg); opacity: 0.7; }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--secondary-text-color);
            border-top-color: var(--text-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #news-feed { display: flex; flex-direction: column; gap: 15px; }

        .news-item {
            border: 1px solid var(--border-color);
            border-radius: 18px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
            overflow: hidden;
        }

        .news-item-header {
            padding: 20px;
            cursor: pointer;
            background-color: var(--card-bg);
        }
        
        .news-item-header:hover { background-color: var(--button-hover-bg); }

        .news-item-body {
            padding: 0 20px 20px 20px;
            max-height: 1000px;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, opacity 0.3s ease-in-out;
            background-color: var(--bg-color);
            opacity: 1;
        }

        .news-item-body.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            overflow: hidden;
        }

        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        .info-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .info-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .info-modal {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
        }

        .info-modal h2 { margin-top: 0; }
        .info-modal p { line-height: 1.6; }

        .info-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--secondary-text-color);
            cursor: pointer;
        }

        .power-mode-control {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 12px;
            border-left: 1px solid var(--border-color);
        }
        .power-mode-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary-text-color);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #adadad;
            transition: .4s;
            border: 1px solid var(--border-color);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        footer {
            padding: 10px 30px;
            border-top: 1px solid var(--border-color);
            background-color: var(--button-bg);
            box-shadow: 0 -2px 4px var(--shadow-color-light);
            position: sticky;
            bottom: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--secondary-text-color);
        }

        .footer-stats {
            display: flex;
            gap: 16px;
            font-weight: 500;
        }

        .footer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .news-item h2 { font-size: 1rem; font-weight: 600; margin: 0 0 8px; }
        .news-item a { color: var(--text-color); text-decoration: none; }
        .news-item a:hover { text-decoration: underline; }
        .metadata { font-size: 12px; color: var(--secondary-text-color); margin-bottom: 10px; }
        .summary { background-color: var(--bg-color); padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 14px; line-height: 1.5; border: 1px solid var(--border-color); }
        .details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 13px; }
        .details h3 { font-size: 15px; font-weight: 600; margin: 15px 0 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        pre { background-color: var(--bg-color); border: 1px solid var(--border-color); padding: 12px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; font-family: SF Mono, Fira Code, monospace; }

        #error-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ff453a;
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        #error-container.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Realtime News Analysis</h1>
            <select id="topicSelect">
                <option value="Stock Market">Stock Market</option>
                <option value="Technology">Technology</option>
                <option value="Artificial Intelligence">Artificial Intelligence</option>
                <option value="Climate Change">Climate Change</option>
                <option value="Biotechnology">Biotechnology</option>
                <option value="Global Economy">Global Economy</option>
                <option value="Cybersecurity">Cybersecurity</option>
            </select>
        </div>
        <div class="header-center">
            <button id="playPauseBtn" class="control-btn">▶<span style="margin-left: 6px;">Start Analysis</span></button>
        </div>
        <div class="header-right">
            <div class="power-mode-control">
                <label for="powerModeToggle" class="power-mode-label">Power Mode</label>
                <label class="switch">
                    <input type="checkbox" id="powerModeToggle" checked>
                    <span class="slider round"></span>
                </label>
            </div>
            <button id="exportBtn" class="control-btn">📥</button>
        </div>
    </header>

    <div class="container">
        <div id="news-feed"></div>
    </div>

    <div id="error-container"></div>

    <div id="infoModalOverlay" class="info-modal-overlay">
        <div class="info-modal">
            <button id="infoModalClose" class="info-modal-close">&times;</button>
            <h2>About This Application</h2>
            <p>This application provides real-time news analysis powered by Cerebras. Press 'Play' to start fetching and analyzing the latest news on a given topic.</p>
            <h3>How to Use:</h3>
            <ul>
                <li><strong>Play/Pause:</strong> Start or stop the news feed.</li>
                <li><strong>Export CSV:</strong> Download the collected analysis data as a CSV file.</li>
                <li><strong>Theme Toggle (🌙/☀️):</strong> Switch between dark and light modes.</li>
            </ul>
        </div>
    </div>

    <footer>
        <div class="footer-controls">
            <button id="infoBtn" class="control-btn">ℹ️</button>
            <button id="themeToggleBtn" class="control-btn">🌙</button>
        </div>
        <div class="footer-stats">
            <span>Avg. Processing Time: <span id="avgProcessingTime">N/A</span></span>
            <span>Avg. TPS: <span id="avgTps">N/A</span></span>
        </div>
        <div>
            <p>&lt;/&gt; with ❤️ by Seb</p>
            <p>powered by Cerebras</p>
        </div>
    </footer>

    <script>
        const playPauseBtn = document.getElementById('playPauseBtn');
        const newsFeed = document.getElementById('news-feed');
        const errorContainer = document.getElementById('error-container');
        const exportBtn = document.getElementById('exportBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const infoBtn = document.getElementById('infoBtn');
        const infoModalOverlay = document.getElementById('infoModalOverlay');
        const infoModalClose = document.getElementById('infoModalClose');
        const powerModeToggle = document.getElementById('powerModeToggle');
        const body = document.body;
        const avgProcessingTimeSpan = document.getElementById('avgProcessingTime');
        const avgTpsSpan = document.getElementById('avgTps');

        const API_URL = `http://${window.location.host}`;
        const WEBSOCKET_URI = `ws://${window.location.host}/ws`;
        let isRunning = false;
        let totalProcessingTime = 0;
        let totalTps = 0;
        let articleCount = 0;

        // --- Event Listeners ---
        async function togglePlayPause() {
            playPauseBtn.disabled = true;
            playPauseBtn.innerHTML = '<div class="spinner"></div>';
            const action = isRunning ? 'pause' : 'start';
            let url;
            if (isRunning) {
                url = `${API_URL}/pause`;
            } else {
                const topic = document.getElementById('topicSelect').value;
                const powerMode = powerModeToggle.checked;
                url = `${API_URL}/start?topic=${encodeURIComponent(topic)}&power_mode=${powerMode}`;
            }

            await fetch(url, { method: 'POST' })
                .catch(err => {
                    console.error(`Failed to ${action}:`, err);
                    showError(`Error: Could not ${action} process.`);
                    // Restore button since status update won't come via WebSocket
                    setStatus(isRunning ? 'running' : 'paused'); 
                })
                .finally(() => {
                    playPauseBtn.disabled = false;
                });
        }

        playPauseBtn.addEventListener('click', togglePlayPause);

        themeToggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            themeToggleBtn.textContent = isDarkMode ? '☀️' : '🌙';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });


        exportBtn.addEventListener('click', () => {
            window.location.href = `${API_URL}/export/csv`;
        });

        infoBtn.addEventListener('click', () => {
            infoModalOverlay.classList.add('visible');
        });

        infoModalClose.addEventListener('click', () => {
            infoModalOverlay.classList.remove('visible');
        });

        infoModalOverlay.addEventListener('click', (e) => {
            if (e.target === infoModalOverlay) {
                infoModalOverlay.classList.remove('visible');
            }
        });

        document.getElementById('topicSelect').addEventListener('change', async () => {
            if (isRunning) {
                await togglePlayPause(); // Stop the current analysis
            }
            document.getElementById('news-feed').innerHTML = ''; // Clear the UI
            resetStats();

            try {
                const response = await fetch('/clear', { method: 'POST' });
                if (response.ok) {
                    console.log('Backend data cleared.');
                } else {
                    console.error('Failed to clear backend data.');
                }
            } catch (error) {
                console.error('Error clearing data:', error);
            }
        });

        // --- State Management ---
        function setStatus(status) {
            isRunning = (status === 'running');
            playPauseBtn.innerHTML = isRunning ? '❚❚<span style="margin-left: 6px;">Stop Analysis</span>' : '▶<span style="margin-left: 6px;">Start Analysis</span>';
            playPauseBtn.disabled = false; // Ensure button is enabled after state confirmation
        }


        // --- UI Feedback ---
        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.add('visible');
            setTimeout(() => {
                errorContainer.classList.remove('visible');
            }, 3000);
        }

        // --- WebSocket Connection ---
        function connect() {
            const ws = new WebSocket(WEBSOCKET_URI);

            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.status) {
                    setStatus(data.status);
                } else {
                    renderNewsItem(data);
                }
            };
            ws.onclose = () => {
                setStatus('error');
                setTimeout(connect, 3000);
            };
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                setStatus('error');
                ws.close();
            };
        }

        // --- Rendering ---
        function renderNewsItem(item) {
            const analysis = item.analysis || {};
            const newsDiv = document.createElement('div');
            newsDiv.className = 'news-item';

            const impacts = (analysis.affected_entities || []).reduce((acc, entity) => {
                acc[entity] = `${analysis.impact_direction[entity]} (${analysis.magnitude[entity]})`;
                return acc;
            }, {});

            const formattedDate = new Date(item.published).toLocaleString();
            const processingTimeMs = (item.processing_time * 1000).toFixed(0);
            let metrics = `${formattedDate} • ${processingTimeMs}ms analysis`;
            if (item.tokens_per_second) {
                metrics += ` • ${item.tokens_per_second.toFixed(0)} t/s`;
            }
            metrics += ` • ID: ${item.task_id}`;

            newsDiv.innerHTML = `
                <div class="news-item-header">
                    <h2><a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a></h2>
                    <p class="metadata">${metrics}</p>
                </div>
                <div class="news-item-body collapsed">
                    <div class="summary"><strong>Summary:</strong> ${analysis.summary_explanation || 'N/A'}</div>
                    <div class="details">
                        <div>
                            <h3>Sentiment & Horizon</h3>
                            <p><strong>Sentiment:</strong> ${analysis.sentiment || 'N/A'} (Confidence: ${(analysis.confidence * 100).toFixed(0)}%)</p>
                            <p><strong>Time Horizon:</strong> ${analysis.time_horizon || 'N/A'}</p>
                        </div>
                        <div>
                            <h3>Affected Entities & Impact</h3>
                            <pre>${JSON.stringify(impacts, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;

            const header = newsDiv.querySelector('.news-item-header');
            const body = newsDiv.querySelector('.news-item-body');

            header.addEventListener('click', () => {
                body.classList.toggle('collapsed');
            });

            newsFeed.prepend(newsDiv);
            updateStats(item);
        }

        function updateStats(item) {
            if (item.processing_time) {
                totalProcessingTime += item.processing_time;
            }
            if (item.tokens_per_second) {
                totalTps += item.tokens_per_second;
            }
            articleCount++;

            const avgProcessingTime = (totalProcessingTime / articleCount) * 1000;
            const avgTps = totalTps / articleCount;

            avgProcessingTimeSpan.textContent = `${avgProcessingTime.toFixed(0)}ms`;
            avgTpsSpan.textContent = avgTps.toFixed(0);
        }

        function resetStats() {
            totalProcessingTime = 0;
            totalTps = 0;
            articleCount = 0;
            avgProcessingTimeSpan.textContent = 'N/A';
            avgTpsSpan.textContent = 'N/A';
        }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.classList.add('dark-mode');
                themeToggleBtn.textContent = '☀️';
            } else {
                body.classList.remove('dark-mode');
                themeToggleBtn.textContent = '🌙';
            }
        }

        // --- Initialisation ---
        applyInitialTheme();
        connect();
    </script>
</body>
</html>
